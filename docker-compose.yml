version: '3.8'

# ─────────────────────────────────────────────────────────────
# Production docker-compose for the NestJS API
#
# Image pulled from Docker Hub on every CI/CD deploy.
# Set DOCKERHUB_USERNAME in your EC2 /opt/ecommerce/.env
#
# External services (no local containers needed):
#   • PostgreSQL → Neon (cloud)
#   • Redis      → Upstash (cloud)
#
# Usage (first time / manual):
#   docker compose --env-file .env up -d
# ─────────────────────────────────────────────────────────────

services:
  api:
    # CI/CD pipeline updates this image tag automatically on every push to main
    image: ${DOCKERHUB_USERNAME}/ecommerce-api:latest
    container_name: ecommerce-api
    restart: unless-stopped

    ports:
      - "127.0.0.1:3001:3001" # localhost only — public traffic goes through Nginx

    environment:
      NODE_ENV: production
      PORT: 3001

      # ── Secrets – loaded from /opt/ecommerce/.env on EC2 ──────────
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      JWT_SECRET: ${JWT_SECRET}

      # ── AWS S3 (for file uploads) ──────────────────────────────────
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}

      # ── Stripe ────────────────────────────────────────────────────
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}

      # ── SMTP / Email ──────────────────────────────────────────────
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}

      # ── CORS / Frontend ───────────────────────────────────────────
      FRONTEND_URL: ${FRONTEND_URL:-https://your-vercel-domain.vercel.app}

    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--spider", "http://localhost:3001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    security_opt:
      - no-new-privileges:true

    # Resource limits — sized for t3.micro (1 GB RAM, 2 vCPU)
    # Hard cap: 512m — leaves ~512m for OS + Nginx
    # Reservation: 256m soft limit — scheduler hint, not a hard floor
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"
        reservations:
          memory: 256m
